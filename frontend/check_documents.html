<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>서류 검증 - 부트캠프 관리 지능화 서비스</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .row-red {
            background-color: #fff !important;
            border-left: 4px solid #000;
        }

        .row-green {
            background-color: #fff !important;
        }

        .ocr-highlight {
            font-family: monospace;
            background: #e2e8f0;
            padding: 2px 4px;
            border-radius: 4px;
        }
    </style>
</head>

<body>
    <div class="wrapper">
        <!-- Sidebar -->
        <div id="content">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="fw-bold text-dark m-0">공가 서류 관리</h2>
                    <p class="text-secondary small mt-1">OCR 기술이 적용된 자동 프리체크 시스템입니다.</p>
                </div>
                <div class="d-md-none">
                    <button type="button" id="sidebarCollapse" class="btn btn-secondary">
                        <i class="fa-solid fa-bars"></i>
                    </button>
                </div>
            </div>

            <!-- Stats -->
            <div class="row g-3 mb-4">
                <div class="col-md-4">
                    <div class="card border-0 shadow-sm p-3 d-flex flex-row align-items-center gap-3">
                        <div class="bg-danger-subtle text-danger rounded-circle d-flex align-items-center justify-content-center"
                            style="width: 50px; height: 50px;">
                            <i class="fa-solid fa-triangle-exclamation"></i>
                        </div>
                        <div>
                            <div class="text-muted small fw-bold">검토 필요 (Red)</div>
                            <h4 class="mb-0 fw-bold" id="count-red">0</h4>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card border-0 shadow-sm p-3 d-flex flex-row align-items-center gap-3">
                        <div class="bg-success-subtle text-success rounded-circle d-flex align-items-center justify-content-center"
                            style="width: 50px; height: 50px;">
                            <i class="fa-solid fa-check"></i>
                        </div>
                        <div>
                            <div class="text-muted small fw-bold">자동 승인 대기 (Green)</div>
                            <h4 class="mb-0 fw-bold" id="count-green">0</h4>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card border-0 shadow-sm">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-light">
                                <tr>
                                    <th class="ps-4">이름</th>
                                    <th>분류</th>
                                    <th>신청 날짜</th>
                                    <th>증빙 날짜 (OCR)</th>
                                    <th>키워드 체크</th>
                                    <th>상태 (AI)</th>
                                    <th>비고 (자동완성)</th>
                                    <th class="text-end pe-4">처리</th>
                                </tr>
                            </thead>
                            <tbody id="docTableBody">
                                <!-- Rows -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/config.js"></script>
    <script src="js/data.js"></script>
    <script src="js/script.js"></script>
    <script>
        // Mock Documents
        // Local Fallback Data
        const getLocalDocs = () => [
            { id: 1, studentId: 1, type: "병가", applyDate: "2024-05-10", proofDate: "2024-05-10", keyword: "처방전", evidence: "file1.jpg" },
            { id: 2, studentId: 2, type: "공가", applyDate: "2024-05-12", proofDate: "2024-05-13", keyword: "예비군", evidence: "file2.jpg" }, // Mismatch
            { id: 3, studentId: 3, type: "공가", applyDate: "2024-05-15", proofDate: "2024-05-15", keyword: "토익시험", evidence: "file3.jpg" }, // Bad key
            { id: 4, studentId: 4, type: "병가", applyDate: "2024-05-20", proofDate: "2024-05-20", keyword: "진료확인서", evidence: "file4.jpg" },
            { id: 5, studentId: 5, type: "기타", applyDate: "2024-05-21", proofDate: "2024-05-21", keyword: "가족여행", evidence: "file5.jpg" }, // Bad key mock
            { id: 6, studentId: 6, type: "병가", applyDate: "2024-05-22", proofDate: "2024-05-22", keyword: "약국영수증", evidence: "file6.jpg" },
        ];

        let currentDocs = [];

        document.addEventListener('DOMContentLoaded', async () => {
            renderSidebar('docs');
            await initData(); // Fetch Students

            // Fetch Documents (Hybrid)
            currentDocs = await callApiOrFallback('/documents?status=PENDING', {}, getLocalDocs);

            renderTable();
        });

        function renderTable() {
            const tbody = document.getElementById('docTableBody');
            tbody.innerHTML = '';

            let redCount = 0;
            let greenCount = 0;

            if (!currentDocs) return;

            currentDocs.forEach(doc => {
                const student = getStudentById(doc.studentId);

                // AI Logic applied here
                let status = "Green";
                let reason = "";
                let rowClass = "row-green";

                // Rule 1: Date Mismatch
                if (doc.applyDate !== doc.proofDate) {
                    status = "Red";
                    reason = "사유: 날짜 불일치(" + doc.proofDate + ")";
                    rowClass = "row-red";
                }

                // Rule 2: Keywords
                const badKeywords = ["토익", "여행", "면접"]; // '면접' per prompt check
                if (badKeywords.some(bad => doc.keyword.includes(bad))) {
                    status = "Red";
                    reason = `사유: 인정 불가(${doc.keyword})`;
                    rowClass = "row-red";
                }

                if (status === "Red") redCount++;
                else greenCount++;

                const tr = document.createElement('tr');
                tr.className = rowClass;

                tr.innerHTML = `
                    <td class="ps-4 fw-bold">${student.name}</td>
                    <td><span class="badge bg-white text-dark border shadow-sm">${doc.type}</span></td>
                    <td>${doc.applyDate}</td>
                    <td><span class="ocr-highlight">${doc.proofDate}</span></td>
                    <td>${doc.keyword}</td>
                    <td>
                        <span class="badge ${status === 'Red' ? 'bg-danger' : 'bg-success'} rounded-pill">
                            ${status === 'Red' ? '확인 필요' : '자동 승인'}
                        </span>
                    </td>
                    <td class="text-danger small fw-bold">${reason}</td>
                    <td class="text-end pe-4">
                        <button class="btn btn-sm btn-dark text-white shadow-sm" onclick="alert('승인되었습니다.')">승인</button>
                        ${status === 'Red' ? `<button class="btn btn-sm btn-outline-danger shadow-sm bg-white" onclick="alert('반려되었습니다.')">반려</button>` : ''}
                        <button class="btn btn-sm btn-link text-muted"><i class="fa-solid fa-paperclip"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('count-red').innerText = redCount;
            document.getElementById('count-green').innerText = greenCount;
        }
    </script>
</body>

</html>